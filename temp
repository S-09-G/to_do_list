"""
FastAPI application for the clustering pipeline.

Run with: uvicorn api.main:app --reload --port 8000
"""

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from api.routes.pipeline_routes import router as pipeline_router


# Create FastAPI app
app = FastAPI(
    title="Samsung User Clustering API",
    description="""
    Configuration-driven user clustering pipeline API.
    
    ## Features
    - **Configuration Management**: Update normalization, algorithms, and parameters
    - **Data Validation**: Validate input data before processing
    - **Feature Engineering**: Run normalization and dimensionality reduction
    - **Clustering**: Compare algorithms and train models
    - **Results**: Retrieve comparison reports and cluster assignments
    
    ## Workflow
    1. Validate data: `GET /api/data/validate`
    2. Run feature engineering: `POST /api/pipeline/features`
    3. Compare algorithms: `POST /api/pipeline/clustering/compare`
    4. Train final model: `POST /api/pipeline/clustering/train`
    """,
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)


# Add CORS middleware (allows frontend to call API)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # In production, specify actual origins
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# Include routes
app.include_router(pipeline_router, prefix="/api")


# ============================================================
# ROOT ENDPOINTS
# ============================================================

@app.get("/", tags=["Health"])
def root():
    """
    Root endpoint - API information.
    """
    return {
        "name": "Samsung User Clustering API",
        "version": "1.0.0",
        "docs": "/docs",
        "health": "/health"
    }


@app.get("/health", tags=["Health"])
def health_check():
    """
    Health check endpoint.
    """
    return {
        "status": "healthy",
        "version": "1.0.0"
    }